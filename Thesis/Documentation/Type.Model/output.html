<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</head>
<body>
<p><strong>Understanding the Type Model: Sarah Urbut</strong></p>
<p>Briefly reintroducing the problem, suppose we have <strong>G</strong> genes upon whose expression we wish to assess in <strong>S</strong> tissues across <strong>N</strong> individuals, and that we also posess genetic information regarding their SNP genotype on these same <strong>N</strong> individuals. In our previous approach, we chose to jointly analyse the possibility that a particular SNP actived in <em>cis</em> as an eQTL across tissues types by enumerating all the possible configurations upon which a SNP could act and then computing a Bayes Factor <span class="math">\(BF_{BMA}\)</span> that quantified the likelihood of a SNP acting as an eQTL by averaging the <span class="math">\(BF_{\gamma}\)</span> likelihood overall possible configurations in which the SNP might be active. As the number of tissues considered in our previous analysis (Flutre <em>et al</em>, PLOS Genetics) becomes sufficiently large, it becomes computationally intractable to enumerate all the <span class="math">\(2^{S}\)</span> possible configurations <span class="math">\(\gamma\)</span>. However, consider that the SNPs might actually fall into a set of 'types' in which given its membership in a particular type <strong>K</strong>, the SNP's predilection towards a particular configuration is generated by some underlying S-dimensional vector specific to the type, such that the SNP's <em>a priori</em> probability of being active in a particular tissue is independent of its activity in another tissue given it's type membership. That is, given an eQTL is of type k, its configuration <span class="math">\(\mathbf \gamma\)</span> is drawn from</p>
<p><span class="math">\(p_{k}( \mathbf \gamma| \mathbf q_{k})\)</span> = <span class="math">\(\prod {q_{ks}^{\gamma_{s}}(1−q_{ks})^{1−\gamma_{s}}}\)</span></p>
<p>We then need only determine the number of types <span class="math">\(K\)</span>, the vector of proportions in each type <span class="math">\(\pi\)</span>, and the <em>S</em>-component vector of probabilities of being active in each tissue given membership in a type, <span class="math">\(q_{k}\)</span>. Thus we have reduced the number of parameters to estimate from <span class="math">\(2^{S}\)</span> down to <span class="math">\(K(S+1)\)</span>, because each type posesses the aforementioned vector of probabilities <span class="math">\(q_{k}\)</span> and the <span class="math">\(\pi\)</span> which corresponds to the probability a SNP is a member of each type. We hope this tutorial will help understanding this model by considering the generative capacity of such a framework.</p>
<p>As an overview,</p>
<ol style="list-style-type: decimal">
<li><p>For simplicity, we assume that (1-<span class="math">\(\pi_{0}\)</span>) genes contain at most one eQTN and that this eQTN lies within 50 base pairs of the TSS. The following refer to SNPs in this category.</p></li>
<li><p>We then assign each SNP to a 'type' according to this probability vector <span class="math">\(\mathbf \pi\)</span>, according the multinomial distribution with probability = <span class="math">\(\mathbf \pi\)</span> and size = 1 (because there is 1 type ID to sort into K potential types).</p></li>
<li><p>Conditional on membership in a type, we generate the <em>1</em> x <em>S</em> vector <span class="math">\(q_{k,}\)</span> containing the type-specific probability of being active in a particular tissue. Here, ach entry <span class="math">\(q_{k,s}\)</span> is drawn from the <span class="math">\(\beta (1,1)\)</span> distribution. The matrix <em>Q</em> contains each of the <em>K</em> <em>S</em> component vectors in its rows.</p></li>
<li><p>Now, conditional on this activity probability <span class="math">\(q_{k}\)</span> and type membership <em>k</em>, we generate a configuration of activity <span class="math">\(\mathbf \gamma_{v}\)</span> for each SNP.</p></li>
</ol>
<p>Now let's program!</p>
<p><code>{r echo=FALSE} library(&quot;MASS&quot;) install.packages(&quot;gtools&quot;) library(gtools) dir.name=&quot;/Users/sarahurbut/genexp/&quot;</code></p>
<pre class="{r}"><code>nb.snps=100000
snps=seq(1,nb.snps)
# anno.snps=sapply(snps,function(x){
#   paste(&quot;rs&quot;,x,sep=&#39;&#39;)})
nb.genes=2000
##record gene.pos in terms of SNPs - e.g., a gene falls every 5 SNPS###
#gene.pos=seq(1,nb.snps,nb.snps/nb.genes)
n.inds=100</code></pre>
<p>Here, we will use K=3 types and S=10 tissue types, but you can modify the situation for your needs. Similarly, for didactic purposes, we will assume that the majority of genes indeed contain an eQTL, thus <span class="math">\(\pi_{0}\)</span> is small (0.30) but you can generate randomly from the <span class="math">\(\beta\)</span> distribution or specify an alternative value.</p>
<pre class="{r}"><code>K=3
S=10
#pi0=rbeta(1,1,1) ##prob gene has no eQTL
pi0=0.3</code></pre>
<p>We should also consider covariates which might affect each tissue separately. Here, we consider only sex.</p>
<pre class="{r}"><code>set.seed(771)
gender=rbinom(n.inds,1,prob=0.5)</code></pre>
<p>Furthermore we generate the vector of Minor Allele Frequencies (MAF) according to the Beta(1,1) distribution. We simulate genotype for each SNP according to this vector from the Binomial distribution.</p>
<pre class="{r}"><code>set.seed(707)
MAF=rbeta(nb.snps,1,1)
###Simulate genotypes in an n x v snps matrix such that each row corresponds to an individuals genotype vector##
n.geno=sapply(MAF,function(x)
  {rbinom(n=n.inds,prob=x,size=2)})</code></pre>
<p>And herein lies the novelty of the method: we will simulate the prior probability of membership in a 'type' from the Dirichlet distribution. According to theses type proportions, we will then assign every SNP membership in a type.</p>
<pre class="{r}"><code>set.seed(771)
(pis=rdirichlet(1,alpha=rep(1,K)))</code></pre>
<p>Thus, about 38%, 26% and 36% of our SNPs are members of 'type' 1,2 or 3 respectively, which will drive their tissue specific expression patterns.</p>
<pre class="{r}"><code>set.seed(302)
###simulate type identity according to pi proportion##
type=sapply(rep(0,nb.snps),function(x){
    assign.vec=rmultinom(n=1,size=1,prob=pis)
    which(assign.vec==1)}
    )
sum(type==1)/length(type)
sum(type==2)/length(type)
sum(type==3)/length(type)</code></pre>
<p>We can check that the type proportion indeed match up with our vector of proportions <span class="math">\(\mathbf \pi\)</span>. Now, we wimulate type-specific vector <span class="math">\(\mathbf q_{k}\)</span>, where <strong>Q</strong> is a <strong>K</strong> x <strong>S</strong> matrix indicating the probability of a SNP being an eQTL at each of the S tissues, given membership in type k.</p>
<pre class="{r}"><code>set.seed(111)
qmat=matrix(NA,nrow=K,ncol=S)
(q.mat=t(apply(qmat,1,function(x){
    x=rbeta(S,1,1)##generate predilection towards config from uniform
    })))</code></pre>
<p>For example, for a SNP in type 1, the probability of being active in tissue 1 given it is the eQTL for the gene is 0.40, but the probability of being active in tissue 4 is close to 1 (0.98). We can see that the type of the SNP broadly dictates correlation patterns of activity between tissues.</p>
<p>Now, similar to my discussion of effect size and variance priors in the earlier tutorial, we simulate the covariance matrix <span class="math">\(\mathbf \sigma_{GV}\)</span> of the multivariate-normally-distributed vector <span class="math">\(\mathbf beta_{s}\)</span> according to the tissue-specific and tissue-average variance <span class="math">\(\phi^{2}\)</span> and <span class="math">\(\omega^{2}\)</span>. We will draw the vector <span class="math">\(\mathbf beta_{s}\)</span> given a SNP's activity according the multivariate normal(0,<span class="math">\(\mathbf \sigma_{GV}\)</span>) with the same covariance matrix for each gene. Similarly, for each gene, we simulate the covariance matrix of the errors between subgroup-expression levels as the <em>N</em> x <em>S</em> identity matrix <em>I</em>, assuming that the errors between tissues are uncorrelated.</p>
<pre class="{r}"><code>####Simulate covariance matrix of effect sizes, same for each gene##
oma2.plus.phi2 &lt;- 0.8^2 # prior variance of subgroup SNP effect
oma2.over.oma2.plus.phi2 &lt;- 3/4 # homogeneity
oma2 &lt;- oma2.plus.phi2 * oma2.over.oma2.plus.phi2 # prior var of avg SNP effect
phi2 &lt;- oma2.plus.phi2 * (1 - oma2.over.oma2.plus.phi2) # prior var of subgroup SNP effect, given avg effect
Sigma.beta.g &lt;- matrix(rep(oma2, S^2),S, S) +
  diag(rep(phi2, S), S, S)
##Simulate covariance matrix of the errors, where we assume no covariance between tissues or individuals (i.e., matrix of multivariate normal S dimensional vectors###
###Key is assuming tissues and individuals are independent###
cov.err.S &lt;- diag(S)</code></pre>
<p>We also need to specify our matrix of covariates, using an inverse <span class="math">\(\gamma\)</span> prior on the tissue-specific variance from which we will draw our vector of tissue-specific effect size, <span class="math">\(\beta_{c}\)</span>.</p>
<pre class="{r}"><code>set.seed(717)
###Create covariate matrix, using inverse gamma prior on variance ###
Sigma.beta.c &lt;- diag(x=1 / rgamma(S, 2, 1),
                     nrow=S, ncol=S)
X.c &lt;- cbind(rep(1, n.inds),gender)#use gender as a covariate
###TissueSpecific covariate effect##
B.c &lt;- matrix(mvrnorm(n=2, mu=rep(0, S),
                      Sigma=Sigma.beta.c),
              nrow=2, ncol=S)</code></pre>
<p>Now, for every gene, we first ask whether it is an 'eGene' - that is, is it affected by an eQTL. This is determined according to <span class="math">\(\pi_{0}\)</span>, the proportion of null genes. Then, conditional on its differential expression, we will choose 1 'true eQTN', assuming 1 eQTN per gene, from set of all SNPS in <em>cis</em>, here defined as within 50 base pairs of the TSS. Given this SNPs type membership, we then generate a tissue-wide vecotr <span class="math">\(\gamma\)</span> dictating the behavior of this gene according to genotype at its eQTN from the type-specific probability vector <span class="math">\(\q_{k}\)</span>.</p>
<pre class="{r}"><code>set.seed(500)
####Initialize DataFrames###
mean.exp=matrix(NA,nrow=nb.genes,ncol=S)
var.exp=matrix(NA,nrow=nb.genes,ncol=S)
cov.eQTL=matrix(NA,nrow=nb.genes,ncol=S)
truth=NULL

configurations=matrix(NA,nrow=nb.genes,ncol=S)
gene.type=NULL
for(i in 1:nb.genes){
  if(runif(1)&lt;pi0){
    X=X.c
    B=B.c
  truth[i]=0
  configurations[i,] = rep(0,S)
  eqtn=0
  gene.type[i]=0
  }
else{
  
  start=50*(i-1)+1
  end=start+49
  cis=snps[start:end]##Specify the cis region
  eqtn=sample(cis,1)##sample the SNP from the chosen region, given that it contains an eQTN
  truth[i]=eqtn
  class=type[eqtn]##membership of the ith SNP
  gene.type[i]=class
  ##generate active tissues according to SNPs type membership#
  probs=q.mat[class,]
  config=sapply(probs,function(x){
  rbinom(1,1,prob=x)})
    configurations[i,] = config
    X.g &lt;- matrix(n.geno[,eqtn], ncol=1)
    B.g &lt;- matrix(mvrnorm(n=1, mu=rep(0, S),Sigma=Sigma.beta.g),nrow=1, ncol=S)
    B.g[1, which(config == 0)] &lt;- 0
    E &lt;- mvrnorm(n=n.inds, mu=rep(0,S),Sigma=cov.err.S)##draw each individuals ERROR vector from E_S(0,I)
    X &lt;- cbind(X.c, X.g)
    B &lt;- rbind(B.c, B.g)
}
  Y &lt;- X %*% B + E
#print(eqtn)

  #write.table(Y, file=paste0(dir.name,i,&quot;explevels.txt&quot;), quote=F, sep=&quot;\t&quot;,
           # row.names=T, col.names=T)

mean.exp[i,]=apply(Y,2,mean)
var.exp[i,]=apply(Y,2,var)
if(eqtn==0){cov.eQTL[i,]=rep(0,S)}
else{cov.eQTL[i,]=apply(Y,2,function(x){cov(x,n.geno[,eqtn])})}
}
  </code></pre>
<p>Note that we have the capacity to create, for every gene, an <em>N</em> by <em>S</em> matrix of expression levels across tissues for all individuals. We can then take the mean expression level for each gene across individuals for each tissue type, and record this in an <em>S</em> dimensional vector. Accordingly, we will have <span class="math">\(M\)</span> of these.</p>
<p>For each tissue, we can then look at boxplots of mean gene expression by type. We can compare these to the vector of configuration probabilities across types for a given tissue, i.e., <em>q[1:K,S]</em> with the expectation that for genes in a type in which the type-specific tissue probabilities <span class="math">\(q_{k,s}\)</span> is higher, there will be a greater variance in gene expression among the disase because the probability that <span class="math">\(\gamma_{s}\)</span> is 1 (and thus the eQTN is active given the gene contains an eQTN) is high. I plot this probability of tissue-specific activity above the type membership identifier.</p>
<pre class="{r}"><code>##########################
###order mean expression by gene.type###
gene.type=as.factor(gene.type)

plot.type=function(cov.eQTL,gene.type,tissue.types){
  par(mfrow=c(1,2),mar=c(5,5,2,2))
  for(i in tissue.types[1]:tissue.types[2]){
  #boxplot(mean.exp[,i]~gene.type,col=1:4,pch=1,xlab=&quot;GeneType&quot;,ylab=&quot;MeanExp&quot;,main=paste(&quot;tissue&quot;,i))
  #boxplot(var.exp[,i]~gene.type,col=1:4,pch=1,xlab=&quot;GeneType&quot;,ylab=&quot;MeanExp&quot;,main=paste(&quot;tissue&quot;,i))
  boxplot(abs(cov.eQTL[,i])~gene.type,ylim=c(-0.05,max(abs(cov.eQTL[,i]))),col=1:4,pch=1,xlab=&quot;GeneType&quot;,ylab=&quot;Cov(Gene,Geno)&quot;,main=paste(&quot;tissue&quot;,i))

  type.probs=round(q.mat[,i],2)
  text(x=2,y=0,type.probs[1],pos=1)
  text(x=3,y=0,type.probs[2],pos=1)
  text(x=4,y=0,type.probs[3],pos=1)
}
}

plot.type(cov.eQTL,gene.type,tissue.types=c(1,2))
plot.type(cov.eQTL,gene.type,tissue.types=c(3,4))
plot.type(cov.eQTL,gene.type,tissue.types=c(5,6))
plot.type(cov.eQTL,gene.type,tissue.types=c(7,8))
plot.type(cov.eQTL,gene.type,tissue.types=c(9,10))

install.packages(&quot;calibrate&quot;)
library(calibrate)

par(mfrow=c(2,5))
for(i in 1:S){
X=seq(1:K)
Y=sapply(seq(1:K),function(x){mean(abs(cov.eQTL[gene.type==x,i]))})
plot(X, Y,pch=1,col=2:4,type=&quot;p&quot;,ylim=c(0,0.5),xlim=c(0,3.5),cex=0.5,main=&quot;mean(abs(cov(gene.exp,geno)))&quot;,xlab=&quot;type&quot;,ylab=&quot;mean(abs(cov(gexp,geno)))&quot;)
library(&quot;calibrate&quot;)
textxy(X, Y, labs=round(q.mat[,i],2),cex=0.5,offset=.1)
       }
</code></pre>
<p>Neatly, let's consider tissue 3 for example. We can see that the covvariance in gene expression with genotype for genes whose eQTN are members of type 1 have a <span class="math">\(q_{1,3}\)</span> of 0.62. We would expect the majority of eQTNs from this type to exhibit active influence on gene expression in this tissue type. Correspondingly, we see that the covariance between gene expression and genotype is much higher for genes containing eQTN of this type than of genes containing eQTNs of type 2, for example. In type 2, the probability of being active in this particular tissue type given membership in type 2 is 0.03, and thus, the absolute value of the covariance between gene epxression and genotype is low.</p>
<p><strong>Applying CorMOTIF</strong></p>
<p>In order to apply this to cormotif, we need to look, gene be gene, at the expression levels for each genotype group. Our matrix will be <span class="math">\(M\)</span> by <span class="math">\(3\)</span> x <span class="math">\(S\)</span>, because we will need to have a mean level of gene expression for each genotype type in all <span class="math">\(S\)</span> tissues.</p>
<p>```{r echo=FALSE} set.seed(500) ####Initialize DataFrames### mean.by.geno=matrix(NA,nrow=nb.genes,ncol=3*S)</p>
<p>truth=NULL</p>
<p>configurations=matrix(NA,nrow=nb.genes,ncol=S) gene.type=NULL for(i in 1:nb.genes){ if(runif(1)&lt;pi0){ X=X.c B=B.c truth[i]=0 eqtn=sample(snps,1)##choose any random snp but record that the snp wasn't a true eqtn gene.type[i]=0 configurations[i,] = rep(0,S) } else{</p>
<p>start=50<em>(i-1)+1 end=start+49 cis=snps[start:end]##Specify the cis region eqtn=sample(cis,1)##sample the SNP from the chosen region, given that it contains an eQTN truth[i]=eqtn class=type[eqtn]##membership of the ith SNP gene.type[i]=class ##generate active tissues according to SNPs type membership# probs=q.mat[class,] config=sapply(probs,function(x){ rbinom(1,1,prob=x)}) configurations[i,] = config X.g &lt;- matrix(n.geno[,eqtn], ncol=1) B.g &lt;- matrix(mvrnorm(n=1, mu=rep(0, S),Sigma=Sigma.beta.g),nrow=1, ncol=S) B.g[1, which(config == 0)] &lt;- 0 E &lt;- mvrnorm(n=n.inds, mu=rep(0,S),Sigma=cov.err.S)##draw each individuals ERROR vector from E_S(0,I) X &lt;- cbind(X.c, X.g) B &lt;- rbind(B.c, B.g) } Y &lt;- X %</em>% B + E</p>
<p>M=(apply(Y,2,function(x){##create a matrix with genotypes in rows and tissues in columns</p>
<pre><code>geno=matrix(n.geno[,eqtn], ncol=1)
if(length(x[geno==0])==0){dom=0}
else{dom=mean(x[geno==0])}

if(length(x[geno==1])==0){het=0}</code></pre>
<p>else{het=mean(x[geno==1])}</p>
<p>if(length(x[geno==2])==0){rec=0} else{rec=mean(x[geno==2])} c(dom,het,rec) })) mean.by.geno[i,] = c((M))##concatenate the rows into 3xS matrix }</p>
<p>cols=matrix(NA,nrow=S,ncol=3) for(i in 1:S){ for(j in 1:3){ cols[i,j]=paste(&quot;Tissue&quot;,i,&quot;Geno&quot;,j) } } colnames(mean.by.geno)=c(cols) ```</p>
<p>However, the corMotif package aims to fit a model for differential expression between two groups, while eQTLs are really differential epxression between three groups.</p>
<p>This code pertains to our particular example, where I will show the flexibility of the model in the sense that within a type, not all SNPs mimic the same 'on' and off configuration in terms of differential expression. We can visualize the 'type-specific signature' similar to corMotif. However, CorMotif aims to capture type-specific differential expression across experiments, while we aim to capture type-specific genotype-associated-differential expression across tissue types. Though similar, our framework requires three levels of comparison for each subgroup, while CorMotif requires only two. I have modified their plotting framework to feature the reflect the proportion of genes in each type who show genotype-specific expression (i.e., the eQTL is active and <span class="math">\(\gamma_{k,s}\)</span> = 1). Thus darker bars indicate that the majority of Gene-SNP pairs in a type reflect an active eQTL relationship in this particular tissue, while lighter bars indicat the the majority of Gene-SNP pairs in a type are 'off' in the particular tissue and thus for most, <span class="math">\(\gamma_{k,s}\)</span> = 0). This is captured by the estimate of <span class="math">\(q_{k,s}\)</span>, which reflects the proportion of SNPs in a type who are active as eQTLs in a particular tissue.</p>
<pre class="{r}"><code>ones=sum(gene.type==1)
  twos=sum(gene.type==2)
  threes=sum(gene.type==3)

freq.mat=apply(configurations,2,function(x){
  ones=sum(gene.type==1)
  twos=sum(gene.type==2)
  threes=sum(gene.type==3)
 c(sum(x[gene.type==1])/ones,
sum(x[gene.type==2])/twos,
sum(x[gene.type==3])/threes)
})



plot.eQTL=function (freq.mat, pis,title = &quot;eQTL&quot;) 
{
    
  
  layout(matrix(1:2, ncol = 2))
    u &lt;- 1:S##Nuber of Tissues
    v &lt;- 1:K##Number of motifs
    image(u, v, t(freq.mat), col = gray(seq(from = 1, 
        to = 0, by = -0.1)), xlab = &quot;Tissues&quot;, yaxt = &quot;n&quot;, ylab = &quot;Types&quot;, 
        main =paste(title, &quot;pattern&quot;, sep = &quot; &quot;))
    axis(2, at = 1:length(v))
    
    for (i in 1:(length(u) + 1)) {
        abline(v = (i - 0.5))
    }
    for (i in 1:(length(v) + 1)) {
        abline(h = (i - 0.5))
    }
  Ng = 10000
  
  genecount = matrix(c(ones,twos,threes),nrow=1)
    NK = nrow(q.mat)
    plot(0, 0.7, pch = &quot;.&quot;, xlim = c(0, 1.2), ylim = c(0.75, 
        NK + 0.25), frame.plot = FALSE, axes = FALSE, xlab = &quot;No. of Gene-SNP pairs in each Class&quot;, 
        ylab = &quot;&quot;, main = paste(title, &quot;frequency&quot;, sep = &quot; &quot;))
    segments(0, 0.7,pis[1], 0.7)
    rect(0, 1:NK - 0.3, pis, 1:NK + 
        0.3, col = &quot;dark grey&quot;)
    mtext(1:NK, at = 1:NK, side = 2, cex = 0.8)
    text(pis + 0.5, 1:NK, labels = paste(genecount,&quot;(&quot;,round(pis,2),&quot;)&quot;,sep=&quot;&quot;))
}


plot.eQTL(freq.mat,pis,title=&quot;eQTL&quot;)</code></pre>
<p>This might be considered analogous to the framework of <em>Structure (Pritchard and Stephens)</em>, where we can think about the SNPs as the individuals belonging to an (unknown) number of subpopulations, here types. Accordingly, within a population, each individual exhibits a vector of alles at each locus drawn accoridng to the population-specific allele frequencies, with the probabilitiy of a given vector simply the product of the population-specific frequencies. Here, within a type, the 'SNPs' exhibit independent assignment of effect on gene-expression at each tissue, such that the probability of a given vector of activity <span class="math">\(\gamma\)</span> is the product of the type-specific probability at teach subgroup (or tissue).</p>
</body>
</html>
